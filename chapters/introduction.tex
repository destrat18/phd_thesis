\chapter{Introduction}
\label{chp:intro}

\section{Prologue}

\para{Blockchain and Smart Contracts} This thesis focuses on designing automated algorithms for (i) optimization problems in blockchains and (ii) detecting vulnerabilities or mathematically verifying their absence in smart contracts. The recent success of Bitcoin~\cite{nakamoto2008bitcoin} has highlighted the potential of blockchains, encouraging researchers to extend the concept of transactions beyond the mere transfer of digital assets to the execution of arbitrary programs, known as smart contracts. Such architectures have become prevalent because centralized systems are vulnerable to fraud, censorship, and manipulation, as they depend on a single authority for control and decision-making. Thus, smart contracts, which can employ any complex logic, remove the need for intermediaries by decentralizing control, making interactions more transparent, tamper-resistant, and censorship-proof. Consequently, they have become instrumental in holding digital assets valued at billions of dollars. Currently, Ethereum, the 2nd largest cryptocurrency with a market cap of $\$354,000,000,000$, and Cardano, the 9th largest with a market cap exceeding $\$14,000,000,000$, both support the execution of arbitrarily complex smart contracts~\cite{coinmarketcap2024cryptocurrency}~\footnote{All prices and exchange rates are as of 01 January 2025.}.


\para{Motivation and Challenges} Vulnerabilities in smart contracts can have devastating consequences, making their security a critical concern. For example, the DAO attack in 2016 resulted in a loss of \$50,000,000, and a recent Bybit hack in February 2025 allowed attackers to steal more than \$1,500,000,000. These losses could have been prevented if the contracts had been formally and rigorously verified. In addition to security, there are also many unsolved or open-ended optimization problems in blockchains. A quintessential example is that users incur execution fees, known as ``gas'', when interacting with contracts. In 2024 alone, Ethereum users spent more than $\$2,700,000,000$ in gas fees. The Ethereum Foundation recognizes that these high fees present a substantial obstacle to broader adoption~\cite{farokhnia2023alleviating}. Thus, any vulnerability or inefficiency can have profound financial repercussions. Relying on unsound heuristics or suboptimal algorithms is unacceptable when billions of dollars are at stake. Rigorous, principled approaches are essential to ensure both the security and efficiency of blockchain systems.


\para{Real-World Applications of Smart Contracts} Smart contracts underpin a wide range of applications across both public and private sectors. In the public sector, they have been adopted in healthcare, crowdfunding, and supply chain management. For instance, the European Commission highlights properties such as trust, privacy, autonomy, inclusiveness, and transparency as key drivers for many projects launched to leverage decentralization for social and public good~\cite{polvora2020scanning}. Another notable example is the Bloxberg blockchain, led by the Max Planck Digital Library, which supports scientific research through smart contract infrastructure~\cite{librarynoyearfirst}. In the private sector, smart contracts have reshaped various financial services such as lending, insurance, and asset management, which are often referred to as decentralized finance (DeFi). Stablecoins like Tether (USDT) and USD Coin (USDC), with market capitalizations of $120,000,000,000$ and $50,000,000,000$, respectively, are implemented as Ethereum smart contracts~\cite{coinmarketcap2024cryptocurrency}. A further illustration is Uniswap, a decentralized exchange (DEX) that allows users to trade digital assets without intermediaries and currently secures $3,400,000,000$~\cite{labs2024uniswap}. Thus, the appeal of decentralization has drawn various professionals to blockchain. However, the cost of operations and potential vulnerabilities remain significant concerns for progress.

Given the rapid adoption of smart contracts, scalable and secure algorithms for verification and optimization are essential. Many formal methods provide soundness (and, where applicable, completeness) but do not scale, while heuristics can leave contracts vulnerable or inefficient. This thesis shows that, by exploiting structural properties of smart contracts, we can achieve the best of both worlds: principled methods that scale in practice. Building on prior work, we study two complementary approaches to these challenges.


\para{Parameterization} The first method is to utilize techniques from parameterized complexity theory.
Many optimization and verification tasks can be framed as graph problems over CFGs of programs. These problems are often intractable. When dealing with intractable problems, e.g.~NP-hard graph problems, parameterized algorithms leverage the structural and sparsity properties of the underlying graphs. Unlike traditional complexity theory, which assesses runtime based solely on input size, parameterized complexity considers both the input size and an additional property of the instance (a ``parameter''). For instance, \textit{treewidth} is a well-known parameter that measures the tree-likeness of a graph, while \textit{treedepth} formalizes the star-like structure of a graph. Many problems that are computationally intractable (e.g.~NP-hard) on general graphs can be efficiently solved on graphs with small treewidth. The intuition is that, if a graph can be decomposed into small parts that are connected to each other in a tree-like manner, then one can treat the graph as if it were a tree and leverage tree-based algorithmic ideas such as bottom-up dynamic programming. It is well known that CFGs of structured programs are sparse and tree-like, i.e.~they have bounded treewidth~\cite{thorup1998all}. The same has also been established for smart contracts~\cite{chatterjee2019treewidth}. See Section~\ref{sec:prelim-parameters} for more details.

\para{Algebro-geometric Methods} Our second approach uses tools from polyhedral and real algebraic geometry. Many of our problems can be formulated as solving systems of constraints. If we submit these constraints directly to a Non-linear Real Arithmetic (NRA) or SMT solver, the solver must handle quantifier alternation, which is very costly. In practice, first-order theories of the reals are slow and often fail even on small examples. To address this, we eliminate quantifier alternation by converting the original formula into an equivalent system of constraints. This produces a quantifier-free instance that is much easier for solvers to process. See Section~\ref{sec:prelim-positivity} for more details.

    
\section{Outline}
This thesis is organized as follows. Chapter~\ref{chp:prelim} presents background on blockchains and smart contracts common to most systems. It then gives system-specific details for Bitcoin (Section~\ref{sec:prelim-bitcoin}), Cardano (Section~\ref{sec:prelim-cardano}), and Ethereum (Section~\ref{sec:prelim-ethereum}). The chapter also introduces the formal definitions and mathematical tools used throughout the thesis, covering parameterized complexity in Section~\ref{sec:prelim-parameters} and algebraic and geometric methods in Section~\ref{sec:prelim-positivity}.

The main body develops principled, scalable methods for two complementary classes of problems: (i) program-level analysis of smart contracts (Chapters~\ref{chp:asparagus} and~\ref{chp:superopt}); and (ii) interactions between users and contracts (Chapters~\ref{chp:mining} and~\ref{chp:hermes}). Chapter~\ref{chp:options} further illustrates that blockchain is inherently interdisciplinary and that rigorous analysis benefits from perspectives beyond computer science. While not the main focus, this demonstrates that mathematically grounded, cross-disciplinary methods can yield novel insights. Each technical chapter presents a clear problem statement, algorithms, and empirical evaluation.

Concretely, the thesis contains the following chapters:

\begin{itemize}
    \item Chapter~\ref{chp:asparagus} proposes a novel approach to automatically synthesize parametric gas-usage upper bounds for smart contracts, using tools and theorems from polyhedral and real algebraic geometry. To the best of our knowledge, this is the first identified use case of algebro-geometric methods in blockchain. Moreover, our approach is the first to successfully synthesize polynomial bounds.

    \item Chapter~\ref{chp:superopt} studies the compiler-optimization problem of gas minimization. We present a dynamic-programming algorithm that builds on, and integrates with, the existing tool \texttt{syrup}, producing more gas-efficient bytecode while retaining correctness guarantees.

    \item Chapter~\ref{chp:mining} addresses block-construction and transaction-selection problems from a miner's perspective for two major cryptocurrencies:
    
    \begin{itemize}
        \item for Cardano (UTXO-based), we present a novel algorithm that exploits the sparsity of interrelations between Cardano transactions. We formulate this problem as a knapsack problem and derive an exact parameterized algorithm based on treewidth;
        
        \item for Ethereum (account-based), we present a novel randomized approach to boost miners' transaction-fee revenues. We observe that a transaction's gas usage is often influenced by a small subset of other transactions, termed its neighborhood.
        Our algorithm uses testing and decision trees to estimate neighborhoods, then derives gas-usage rules to predict each transactionâ€™s fee. The rules are encoded as an ILP instance and solved with an external ILP solver.
    \end{itemize}

    \item Chapter~\ref{chp:hermes} presents an extension of a treewidth-based algorithm for optimal routing on DEXs. By leveraging the structural properties of liquidity pools, the proposed approach bridges the gap between scalability and robustness. To our knowledge, this is the first application of parameterized algorithms in the context of DEXs.
    
    \item Chapter~\ref{chp:options} refutes several common misconceptions regarding Bitcoin's security against block-reverting attacks. Specifically, we show that a successful block-reverting attack does not necessarily require (even close to) a majority of the hash power, and that Bitcoin derivatives, i.e.~options and futures, imperil Bitcoin's security by creating an incentive for a block-reverting/majority attack.
\end{itemize}


Finally, Chapter~\ref{chp:conclusion} provides a discussion of broader impacts and summarizes the main findings and future directions of the thesis.


\section{Summary of Contributions}
The main contributions of each chapter are outlined below:

\begin{itemize}
    \item In Chapter~\ref{chp:asparagus}, we consider the problem of finding polynomial gas-usage upper bounds for every function of a given smart contract. We model smart contracts as polynomial transition systems (PTSs), and our contributions are as follows:
    \begin{itemize}
        \item \emph{Theoretical Contributions.} We provide novel and fully automated algorithms, based on techniques from polyhedral and real algebraic geometry, to synthesize the tightest possible polynomial gas upper bounds for a given PTS. We show that our approach is not only sound, but also semi-complete, i.e.~complete when the polynomial degree is sufficiently large. Our theoretical approach is language-independent and can be applied to smart contracts written in any language and run on top of any blockchain protocol.
        \item \emph{Practical Contributions.} We provide extensive experimental results on 156,735 functions from 24,188 real-world smart contracts, showing that our approach is scalable and applicable to the vast majority of real-world Ethereum contracts (80.56\%). Moreover, we compare our results with GASTAP, the only previous method that could synthesize parametric bounds. Our experiments demonstrate that Asparagus outperforms GASTAP both in terms of the number of contracts it can handle and the quality and tightness of the bounds.
    \end{itemize}

    \item In Chapter~\ref{chp:superopt}, we study the compiler-optimization problem of gas minimization, and we make the following contributions:
    \begin{itemize}
        \item \emph{Theoretical Contributions.} We provide a simple dynamic-programming approach to enhance superoptimization techniques for reducing the gas usage of smart contracts.
        \item \emph{Practical Contributions.} We implement our approach and integrate it with \texttt{syrup 2.0}, the current state-of-the-art gas optimizer for Ethereum smart contracts. Over a benchmark set of \todo{148} real-world and commonly called smart contracts on the Ethereum blockchain, we find that our approach more than doubles the benefits of \texttt{syrup}, increasing gas savings from \todo{4.17}\% to \todo{11.23}\%.
    \end{itemize}

    \item In Chapter~\ref{chp:mining}, we consider the problem of Maximizing miner/producers revenues, i.e.~a block with maximum total transaction fees, in Cardano and Ethereum. Our contributions are as follows:
    \begin{itemize}
        \item For Cardano, we exploit the sparsity of interrelations between real-world Cardano transactions to find the optimal block to mine. Specifically:
        \begin{itemize}
            \item \emph{Theoretical Contributions.} Since the problem is NP-hard, we obtain an algorithm that has polynomial runtime for real-world instances of the problem. Formally, we consider a graph of interrelations between transactions and show that when this graph has bounded treedepth, i.e.~when it is sparse and resembles a shallow tree, there is a polynomial-time algorithm for finding the optimal block to mine.
            
            \item \emph{Practical Contributions.} We experimentally show that the small-treedepth assumption holds for real-world Cardano instances. With the help of the Cardano Foundation, we conduct a \todo{50}-day-long experiment on the Cardano blockchain in which we run our algorithm on the same sets of transactions as those available to real-world Cardano block producers and compare the blocks produced by our approach with those actually added to Cardano. Our approach increases transaction-fee revenues by \todo{1,357.82} USD/day (= \todo{495,604.3} USD/year). Thus, producing optimal blocks that maximize transaction fees yields significant benefits in practice.
        \end{itemize}

        \item For Ethereum, we design and present a randomized algorithm to create a block that maximizes the miner's total tip revenue. Specifically:
        \begin{itemize}
            \item \emph{Theoretical Contributions.} We execute test cases (random permutations of transactions in a transaction pool) and profile their gas usage. Then, using decision trees, for every transaction in the pool, we identify a set of other transactions that can affect its gas usage; we call this set its \emph{neighborhood}. Intuitively, we expect neighborhoods to be small because most transactions are independent; for example, two transactions that do not access the same smart contracts cannot affect each other's gas usage. We provide a probabilistic argument showing that, with high probability, our testing covers every possible permutation of each neighborhood. We cut, mix, and glue together parts of our test cases to create a block that maximizes the miner's total tip revenue. We model this step as an ILP instance and solve it using an external optimization suite. All steps of our algorithm are parallelizable and, except for the ILP solver, run in polynomial time. Because it relies on randomized sampling and ILP solvers, our algorithm is not guaranteed to always produce an optimal result.
            
            \item \emph{Practical Contributions.} We implement our algorithm and perform extensive experiments on 50,000 Ethereum blocks. For each block, we gather real-world transaction pool data and execute our algorithm. We then compare the tip revenues obtained by our framework with those of real-world miners. Our approach increases tip revenues by 73.45\% on average per block, corresponding to roughly 24.1 USD per block and 63,357,892 USD per year at current exchange rates. We also compare our tool against the default Ethereum implementation and find that our approach increases tip revenues by 18.56\% on average per block, corresponding to roughly 17.3 USD per block and 45,416,764 USD per year.
        \end{itemize}
    \end{itemize}
    
    \item In Chapter~\ref{chp:hermes}, we analyze the structural properties of Uniswap exchange pools, with the following contributions:
    \begin{itemize}
        \item \emph{Theoretical Contributions.} We extend a parameterized algorithm that leverages the low treewidth of DEX graphs to find routes efficiently. The algorithm is specifically tailored for the dynamic, online environment of DEXs, where liquidity pools are constantly changing. Our formal complexity analysis shows that its theoretical runtime outperforms state-of-the-art algorithms.
        \item \emph{Practical Contributions.} We implement the algorithm in an open-source routing tool called Hermes and conduct a comprehensive experimental evaluation using real-world Uniswap transaction data covering \todo{$20{,}000$} blocks. The results show that our treewidth-based approach achieves superior practical performance compared to existing methods. Hermes is the only method capable of processing token sets of size $100{,}000$, with an average query time of 0.19 seconds. For instances where both tools yield results, Hermes reduces the average runtime from 2.81 seconds to 0.0002 seconds, an improvement of over four orders of magnitude.
    \end{itemize}

    \item In Chapter~\ref{chp:options}, we refute several common misconceptions regarding Bitcoin's security against block-reverting attacks. In particular, we show that:
    \begin{itemize}
        \item a successful block-reverting attack does not necessarily require (even close to) a majority of the hash power;
        \item obtaining a majority of the hash power (or a sufficient minority for a block-reverting attack) costs roughly 6.77 billion USD or 2.90 billion USD, respectively, which is far lower than commonly assumed and about two orders of magnitude smaller than the Bitcoin market cap; and
        \item Bitcoin derivatives (options and futures) can imperil Bitcoin's security by creating incentives for block-reverting/majority attacks.
    \end{itemize}
\end{itemize}

\section{Awards}
The research presented in Chapter~\ref{chp:mining} received an Academic Grant (ESP) from the Ethereum Foundation. Chapter~\ref{chp:superopt} led to the award of a research fellowship from the Humboldt Foundation. The work on Cardano block production (Sections~\ref{sec:mining-cardano-problem}--\ref{sec:mining-cardano-experiments}) was conducted in collaboration with the Cardano Foundation, and the resulting research was invited for presentation at the Cardano Summit~2024.
Chapters~\ref{chp:mining} and~\ref{chp:asparagus} each received a Research Travel Grant from the Hong Kong Research Grants Council to attend the conference and present the paper.